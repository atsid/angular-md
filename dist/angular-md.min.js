angular.module("atsid.namedError",[]).provider("namedError",function(){this.$get=function(){return function(a,b){var c=function(a,c){this.name=a,this.message=c||b};return c.prototype=Error.prototype,c}}}),angular.module("atsid.eventable",[]).provider("eventable",[function(){function a(a){angular.extend(this,a)}a.prototype={_getEventableScope:function(){return this},_getEventListeners:function(a){var b=this._getEventableScope(),c=b.$eventMessages=b.$eventMessages||{},d=c[a];return d||(d=c[a]=[]),d},hasListeners:function(a){return!!this._getEventableScope()._getEventListeners(a)},emit:function(a,b){var c=Array.prototype.slice.call(arguments,1),d=this._getEventListeners(a),e={message:a,data:b,preventDefault:function(){e.defaultPrevented=!0},defaultPrevented:!1};return c.unshift(e),d.forEach(function(a){a.fn.apply(a.target,c)}),e},on:function(a,b){var c=this._getEventListeners(a),d={fn:b,target:this,remove:function(){var a=c.indexOf(this);c.splice(a,1)}};return c.push(d),d}},this.$get=function(){return function(b,c){return new a(b,c)}}}]),angular.module("atsid.data.store",["atsid.namedError","atsid.eventable"]).provider("store",function(){this.$get=["namedError","eventable",function(a,b){var c={NotImlementedError:a("NotImlementedError","Not implemented"),NotFoundError:a("NotFoundError","Not Found")},d=function(a){return b(angular.extend({config:{},read:function(){throw new c.NotImlementedError},create:function(){throw new c.NotImlementedError},update:function(){throw new c.NotImlementedError},patch:function(){throw new c.NotImlementedError},"delete":function(){throw new c.NotImlementedError},createResponse:function(a,b,c){var d=a instanceof Array,e=d?a.length:1;return{data:a,count:e,offset:b||0,total:c||e}},sanitizeData:function(a){for(var b,c={},d=Object.keys(a),e=d.length;e-->0;)b=d[e],/^[$]/.test(d[e])||(c[b]=angular.copy(a[b]));return c},getValueAtPath:function(a,b){var c,d,e=(a||"").split("/");return(e.length>1||e[0])&&(d=b,e.every(function(a){return d=d[a],d?(c=d,!0):void 0})),d}},a))};return d.errors=c,d}]}),angular.module("atsid.data.store").provider("httpStore",[function(){var a={};this.addStore=function(b){if(!angular.isString(b.name))throw new Error("Global http store defaults require a name.");a[b.name]=b},this.$get=["$http","store","$cacheFactory",function(b,c,d){function e(b){var c=angular.extend({response:{paths:{count:"count",data:"data",offset:"offset",total:"total"}},methods:{get:null,put:null,patch:null,post:null,"delete":null}},a[b.name]||{});this.config=angular.extend(angular.extend({},c),b),this.buildTransformers(b.transformers||[])}return e.prototype=c({parseResponse:function(a,b,c){var d=this.getValueAtPath("methods/"+a+"response",b)||b.response,e=d.paths||{},f=this.getValueAtPath(e.data,c)||c,g=angular.isArray(f);return this.hasTransformers("response")&&(f=this.runTransformers("response",f,[]),f&&!g&&(f=f[0])),this.createResponse(f,this.getValueAtPath(e.offset,c),this.getValueAtPath(e.total,c))},buildUrl:function(a,b){a=a||"";var c=this.config.baseUrl||"",d=[],e=a&&"/"!==c.charAt(c.length-1)?"/":"";return a=c+e+a,angular.forEach(b,function(a,b){d.push(b+"="+encodeURIComponent(a))}),d.length&&(a+="?"+d.join("&")),a},getCache:function(a){return this.cache||(this.cache=d(a)),this.cache},invalidateCache:function(){this.cache&&this.cache.removeAll()},doRequest:function(a,c,d,e,f,g){var h=this.config,i=this,j=angular.isArray(f);return this.hasTransformers("request")&&(f=this.runTransformers("request",f),f&&!j&&(f=f[0])),b({method:a,url:this.buildUrl(c,d),data:f||"",headers:angular.extend(angular.extend({},this.config.headers),e),cache:g.cache?this.getCache(c):!1}).then(function(b){return i.parseResponse(a.toLowerCase(),h,b.data)})},read:function(a,b,c,d){return this.doRequest("GET",a,b,{},c,d)},create:function(a,b,c,d){return this.invalidateCache(),this.doRequest("POST",a,b,{},c,d)},update:function(a,b,c,d){return this.invalidateCache(),this.doRequest("PUT",a,b,{},c,d)},patch:function(a,b,c,d){return this.invalidateCache(),this.doRequest("PATCH",a,b,{},c,d)},"delete":function(a,b,c,d){return this.invalidateCache(),this.doRequest("DELETE",a,b,{"Content-Type":angular.isArray(c)?"application/json":null},c,d)},buildTransformers:function(a){var b=this.transformerMap={};(a||[]).forEach(function(a){var c=b[a.type]=b[a.type]||[];c.push(a)})},runTransformers:function(a,b,c){var d=this.transformerMap,e=b,f=d[a];return f&&b&&f.forEach(function(a){e=a.transform(e,c)}),e},hasTransformers:function(a){return this.transformerMap&&this.transformerMap[a]}}),function(a){return a=angular.isString(a)?{name:a}:a||{},new e(a)}}]}]),angular.module("atsid.data.store").provider("arrayStore",[function(){this.$get=["store","namedError",function(a){function b(a){a=a||{},this.array=[],this.idProperty=a.idProperty||"id",this.idToItems={},this.sanitize=a.hasOwnProperty("sanitize")?a.sanitize:!0,a.getId&&(this.getId=a.getId),this.uid=0,this.setItems(angular.isArray(a)?a:a.array||[])}return b.prototype=a({_addItem:function(a,b){var c=this.idProperty;if((null===a[c]||void 0===a[c])&&(a[c]=this.getId()),this.sanitize&&(a=this.sanitizeData(a)),this.idToItems[a[c]]){if(!b)return;var d=this.array.indexOf(a);this.array.splice(d,1,a)}else this.array.push(a);return this.idToItems[a[c]]=a,this.sanitize?angular.copy(a):a},getId:function(){do this.uid+=1;while(this.idToItems[this.uid]);return this.uid},setItems:function(a){this.array.splice(0,this.array.length),this.idToItems={},this.uid=0,a.forEach(function(a){this._addItem(a)},this)},findItem:function(a){var b=this.idToItems[a];return b&&this.sanitize&&(b=angular.copy(b)),b},hasItem:function(a){return angular.isArray(a)?a.every(function(a){return this.hasItem(a)},this):void 0!==a[this.idProperty]&&null!==a[this.idProperty]?!!this.idToItems[a[this.idProperty]]:!!this.idToItems[a]},refreshItemId:function(a,b){this.idToItems[a]&&(delete this.idToItems[a],this.idToItems[b[this.idProperty]]=b,this._addItem(b,!0))},read:function(b){var c;return c=void 0!==b&&null!==b?this.findItem(b):this.sanitize?angular.copy(this.array):this.array.slice(0),c?this.createResponse(c):new a.errors.NotFoundError("No item at path "+b)},create:function(a,b,c){this.idProperty;return this.createResponse(angular.isArray(c)?c.map(function(a){return this._addItem(a)},this):this._addItem(c))},update:function(b,c,d){if(angular.isArray(d)){if(this.hasItem(d))return this.createResponse(d.map(function(a){return this._addItem(a,!0)},this))}else if(this.hasItem(b||c[this.idProperty]))return this.createResponse(this._addItem(d,!0));return new a.errors.NotFoundError("No item at path "+b)},patch:function(b,c,d){if(angular.isArray(d)){if(this.hasItem(d))return this.createResponse(d.map(function(a){var b=this.findItem(a[this.idProperty]);return angular.extend(b,a),this._addItem(b,!0)},this))}else{var e=this.findItem(b);if(e)return angular.extend(e,d),this.createResponse(this._addItem(e,!0))}return new a.errors.NotFoundError("No item at path "+b)},"delete":function(b,c,d){if(d)return this.hasItem(d)?(d.forEach(function(a){a=this.idToItems[a[this.idProperty]];var b=this.array.indexOf(a);this.array.splice(b,1),delete this.idToItems[a[this.idProperty]]},this),this.createResponse(null)):new a.errors.NotFoundError("No item at path "+b);var e={};return e[this.idProperty]=c[this.idProperty],this["delete"](null,c,[e])}}),function(a){return new b(a)}}]}]),angular.module("atsid.data",["atsid.eventable","atsid.data.store"]).provider("dataSource",[function(){function a(a){return angular.extend(a,{defaults:{idProperty:"id",fields:null,fetches:null,q:null,orderBy:null,count:100,offset:0,allowAutomaticRoutes:!0},storeConfig:"http",routes:{}}),{setDefaults:function(b){angular.extend(a.defaults,b)},setStore:function(b){a.store=b,a.storeConfig=null},setStoreConfig:function(b){a.storeConfig=b,a.store=null},setStoreUrl:function(b){a.storeConfig={type:"http",baseUrl:b},a.store=null},setStoreTransformers:function(b){a.storeConfig.transformers=b},addRoutes:function(b){angular.extend(a.routes,b)}}}var b={};angular.extend(this,a(b)),this.$get=["$q","httpStore","arrayStore","eventable","namedError",function(c,d,e,f,g){function h(a){return a=angular.isString(a)?{type:"http",name:a}:a,{http:d,array:e}[a.type||"http"](a)}function i(a,b){{var c=[];a.length-1}return a.forEach(function(a){if(null!==a.name&&c.push(a.name),null!==a.param){var d=b?b[a.param]||null:":"+a.param;d&&c.push(d)}}),c.join("/")}function j(a,b){var c=a.path,d=!c&&b?b.pathComponents.slice(0):[];if(c){c=c.replace(/^\/|\/$/,""),c=c.split("/");for(var e=0;e<c.length;){var f=c[e],g=c[e+1];":"===f.charAt(0)&&(g=f,f=null,e-=1),g=g&&":"===g.charAt(0)?g.substr(1):null,d.push({name:f,param:g}),e+=g?2:1}}else a.name&&d.push({name:a.name,param:"id"+(b.level+1)});return d}function k(a,b){var c=this;if(a=a||{},b){var d=function(){};d.prototype=b,c=new d}var e=c.pathComponents=j(a,b),f=e[e.length-1];return c.config=a,c.path=i(e),c.level=b?b.level+1:1,c.idProperty=a.idProperty||"id",c.parent=b,c.pathName=f&&f.name||"",c.name=a.name||c.pathName,c.pathParam=f&&f.param||"",c.params=a.params||{},c.routes={},c.fields=a.fields,c.fetches=a.fetches,c.q=a.q,c.orderBy=a.orderBy,c.transformers=a.transformers||[],c.buildTransformers(c.transformers),c.cache=a.cache||!1,a.count&&(c.count=a.count),a.offset&&(c.offset=a.offset),b?(c.nameToRoute=Object.create(c.nameToRoute),b.routes[c.pathName]=c):(c.nameToRoute={},c.allowAutomaticRoutes=a.allowAutomaticRoutes,c.root=this,a.store&&c.setStore(a.store)),a.routes&&angular.forEach(a.routes,function(a,b){a.path?a.name=b:a.path=b,c.addRoute(a)}),c._self=c,c}function l(a){var b=new k(angular.extend({store:a.store||h(a.storeConfig),routes:a.routes},a.defaults));return b}var m={NotRootRouteError:g("NotRootRouteError","Must be the root route to use this feature"),ParameterError:g("ParameterError","Missing Parameter"),RouteNotFoundError:g("RouteNotFoundError","The route does not exist")};k.prototype=f({setStore:function(a){if(this.root!==this)throw new m.NotRootRouteError("Must be the root route to set the store");var b=this.store;b&&this.storeListeners&&this.storeListeners.forEach(function(a){a.remove()}),this.store=a,a&&(this.storeListeners=[a.on("message",function(){var a=Array.prototype.slice.call(arguments,1);this.emit.apply(this,a)})])},addRoute:function(a){if(this._adding=!0,!a||!a.path&&!a.name)throw new m.ParameterError("Cannot create route without a name or path.");a.path&&"/"!==a.path.charAt(0)&&this.path&&(a.path=this.path+"/"+a.path);var b=a.path?this.root.getRouteByPath(a.path,!0):this,c=new k(a,b);return a.name&&(this.root.nameToRoute[a.name]=this.nameToRoute[a.name]=c),this._adding=!1,c},child:function(a){if(a=angular.isString(a)?{name:a}:a,!a.name&&!a.path)throw new m.ParameterError("Cannot create route without a name or path.");var b=this._getRouteByNameOrPath(a.path||a.name);if(!b){if(!this.allowAutomaticRoutes)throw new Error('Route "'+(a.path||a.name)+'" does not exist.');b=new k(a,this)}return b.getInstance(a,this.isEqual(this.root)?null:this)},_getRouteByNameOrPath:function(a){return this.nameToRoute[a]||this.getRouteByPath(a)},getRouteByPath:function(a,b){return this.getRouteByPathComponents(j({path:a}),b)},getRouteByPathComponents:function(a,b){var c=this;return b&&(a=a.slice(0,a.length-1)),a.every(function(a){var b=c.routes[a.name];if(!b){if(!c._adding&&!c.allowAutomaticRoutes)throw new m.RouteNotFoundError('The route, "'+a.name+'", does not exist');b=c.addRoute({path:a.name})}return c=b,!0}),c},getParent:function(a){var b=this.parent;return b?a&&b.name!==a?b.getParent(a):b:void 0},setParentItem:function(a,b){b||(b=a,a=null);var c=this.getParent(a);c&&c.setItem(b),this.emit("parentItemChanged",b)},getPathParams:function(a){var b={},c=this.getParent(),d=this.pathComponents,e=d.length-2,f=d[e],g=a[this.idProperty]||a[this.pathParam];for(void 0!==g&&null!==g&&(b[this.pathParam]=g);c&&f;)b[f.param]=c.currentItem&&c.currentItem[c.idProperty]||a[f.param],c=c.getParent(),e-=1,f=d[e];return b},setItem:function(a){this.currentItem=a,this.emit("itemChanged",a)},getInstance:function(a,b){var c;if(Object.create)c=Object.create(this);else{var d=function(){};d.prototype=this,c=new d}return c.config=angular.extend(angular.extend({},this.config),a),b?c.parent=b:c.parent&&(c.parent=c.parent.getInstance()),angular.extend(c,a||{})},getPath:function(a){var b=this.getPathParams(a||{});return i(this.pathComponents,b)},getUrl:function(a,b){var c=this.getPath(a);return this.store.buildUrl(c,this.getStoreParams(b||{}))},getStoreParams:function(a){var b=angular.extend(angular.extend({fields:this.fields,fetches:this.fetches,q:this.q,count:this.count,offset:this.offset,orderBy:this.orderBy},this.params||{}),a);return this.pathComponents.forEach(function(a){b[a.param]&&delete b[a.param]}),angular.forEach(b,function(a,c){(null===a||void 0===a)&&delete b[c]}),b},isEqual:function(a){return a._self===this._self},buildTransformers:function(a){var b=this.transformerMap={};(a||[]).forEach(function(a){var c=b[a.type]=b[a.type]||[];c.push(a)})},runTransformers:function(a,b,c){var d=this.transformerMap,e=b,f=d[a];return f&&b&&f.forEach(function(a){e=a.transform(e,c)}),e},hasTransformers:function(a){return this.transformerMap&&this.transformerMap[a]},doRequest:function(a,b,d){var e=c.defer(),f=angular.isArray(d),g=!d||f?d:[d],h=this;b=angular.extend(angular.copy(this.params||{}),b||{});var i=this.getPath(b),j=this.getStoreParams(b),k={cache:this.cache};this.hasTransformers("request")&&(d=this.runTransformers("request",g),d&&!f&&(d=d[0])),this.emit("request",{method:a,path:i,params:j,data:d});var l=this.store[a](i||null,j,d,k);return l.then?l.then(function(b){e.resolve(h._resolveRequest(a,i,j,g,b))},function(a){h.emit("error",a),e.reject(a)}):l instanceof Error?(h.emit("error",l),e.reject(l)):e.resolve(this._resolveRequest(a,i,j,g,l)),e.promise},_resolveRequest:function(a,b,c,d,e){var f=angular.isArray(e.data),g=!e.data||f?e.data:[e.data];return this.hasTransformers("response")&&(g=this.runTransformers("response",g,d||[]),g&&!f&&(g=g[0]),e.data=g),this.emit("response",{method:a,path:b,params:c,response:e}),this.emit(a,e.data),e},query:function(a){return this.doRequest("read",a)},get:function(a){if(a=angular.isObject(a)?a:{id:a},!a.id)throw new m.ParameterError("Requires an item id or parameters that include an id.");return this.query(a)},create:function(a,b){if(!a)throw new m.ParameterError("Requires an item to create.");return b=b||{},this.doRequest("create",b,a)},update:function(a,b){if(!a)throw new m.ParameterError("Requires an item to update.");return b=b||{},b[this.idProperty]=a[this.idProperty],this.doRequest("update",b,a)},save:function(a,b){return a.hasOwnProperty(this.idProperty)?this.update(a,b):this.create(a,b)},"delete":function(a,b){if(!a)throw new m.ParameterError("Requires an item to delete.");return b=b||{},angular.isArray(a)?this.doRequest("delete",b,a):(b[this.idProperty]=a[this.idProperty],this.doRequest("delete",b))},remove:function(a,b){return this["delete"](a,b)},batch:function(a,b){var d=[];b||(b=a,a=null);var e=function(a,b){return b&&d.splice(d.indexOf(b),1),d.push(a),a},f=function(a){return{then:function(b,c){var d=e(a.then(b,c),a);return f(d)}}},g=function(a,b,c){var g=e(a[b].apply(a,c));return f(g,function(){d.splice(d.indexOf(g),1)})},h=this.getInstance({query:function(){return g(h,"query",arguments)},get:function(){return g(h,"get",arguments)},create:function(){return g(h,"create",arguments)},update:function(){return g(h,"update",arguments)},save:function(){return g(h,"save",arguments)},"delete":function(){return g(h,"delete",arguments)},remove:function(){return g(h,"delete",arguments)}});return a?a.forEach(b,h):b.call(h),c.all(d)}});var n=new l(b),o=function(a){return a?n.child(a):n.getInstance()};return o.createDataSource=function(b){var c={},d=a(c);return angular.isFunction(b)?b.call(d,d):angular.isObject(b)&&d.setDefaults(b),new l(c)},o.errors=m,o}]}]),angular.module("atsid.data.itemCollection",["atsid.eventable","atsid.data"]).provider("itemCollection",[function(){this.$get=["dataSource","arrayStore","eventable","$q","$timeout",function(a,b,c,d,e){function f(a,b){var c={collection:b,originalData:{},unsaved:!1};this.$meta=function(){return c},this.setData(a)}function g(b){angular.extend(this,angular.extend({saveWithParent:!1},b)),this.dataSource=angular.isString(b.dataSource)?a(b.dataSource):b.dataSource,this.idProperty=this.dataSource.idProperty;var c=this.parentItem;if(c){var d=this;c.on("didRevertChanges",function(){d.revertChanges()})}this.setItems(this.items||[])}return f.prototype=angular.extend(c(),{getData:function(a,b){var c={},d=a?this.$meta().originalData:this,e=this.exists();for(var f in d)d.hasOwnProperty(f)&&"$"!==f.charAt(0)&&(f!==this.$meta().collection.idProperty||e||b)&&(c[f]=d[f]);return c},setData:function(a,b){for(var c,d=this.$meta().originalData,e=Object.keys(a),f=0;f<e.length;f++)c=e[f],"$meta"!==c&&(b&&this.hasOwnProperty(c)&&d[c]!==this[c]||(this[c]=angular.copy(a[c])),d[c]=a[c])},forEachChild:function(a){var b=[],c=this.$meta().collectionCache,d=!1,e=function(){d=!0};return c&&Object.keys(c).some(function(f){return b.push(a(c[f],e)),d}),b},revertChanges:function(){this.setData(this.$meta().originalData),this.forEachChild(function(a){a.revertChanges()}),this.emit("didRevertChanges",this)},hasChanges:function(a){var b=!angular.equals(this.getData(),this.$meta().originalData);return!b&&a&&this.forEachChild(function(a,c){b=a.hasChanges(),b&&c()}),b},query:function(a){return this.$meta().collection.queryItem(this,a)},save:function(a){var b=this,c=d.defer();return this.$meta().collection.saveItem(this,a||!1).then(function(a,e){var f=[];b.$meta().unsaved=e,a.emit("didSave",a,function(a){f.push(a)}),d.all(f).then(function(){c.resolve(a)},function(){c.resolve(a)})}),c.promise},isSaved:function(){return!this.$meta().unsaved},isDeleted:function(){return this.$meta().deleted},exists:function(){var a=this.$meta().collection.idProperty;return 0!==String(this[a]).search("temp")&&!this.isDeleted()&&this.isSaved()&&void 0!==this[a]&&null!==this[a]},"delete":function(a){var b=this;return this.$meta().collection.deleteItem(this,a||!1).then(function(){b.$meta().unsaved=!1,b.$meta().deleted=!0})},remove:function(a){return this["delete"](a)},select:function(a){this.$meta().collection.selectItem(this,a)},isIn:function(a){return this.$meta().collection===a},child:function(a){var b,c=angular.isString(a)?{name:a}:a,d=this.$meta(),e=d.collection,f=d.collectionCache,h=e.children||{};if(f||(f=d.collectionCache={}),f[c.name])return f[c.name];h?(b=h[c.name]||{},angular.extend(c,angular.isString(b)?{dataSource:b}:b),c.items=this[c.name]):c=angular.isString(a)?{dataSource:a}:a;var i=angular.extend({saveWithParent:e.saveChildren,saveChildren:e.saveChildren},c);i.parentItem=this;var j=i.dataSource=e.dataSource.child(i.dataSource);j.setParentItem(this);var k=f[c.name]=new g(i);return k},saveChildren:function(a){var b=this;return d.all(this.forEachChild(function(c){return c.dataSource.setParentItem(b),c.saveChanges(a)}))}}),g.prototype=angular.extend(c(),{getDataSource:function(a){return a||void 0===a&&this._canSave()?this.dataSource:this.tempDataSource},_refreshItems:function(a,b){return b=b||[],a.map(function(a,c){var d=b[c]&&b[c][this.idProperty]||a[this.idProperty],e=void 0!==d&&null!==d&&this.itemStore.read(d),f=e&&e.data;return f?(f.setData(a),d!==a[this.idProperty]&&this.itemStore.refreshItemId(d,f)):(f=b[c],f&&f.isIn&&f.isIn(this)&&f.setData(a),f=this.addItem(f||a)),f},this)},_canSave:function(){return!this.saveWithParent&&(!this.parentItem||this.parentItem.exists())},_verifyItem:function(a){if(!a.isIn||!a.isIn(this))throw new Error("Tried to perform an action on item that is not within the collection.");if(a.isDeleted())throw new Error("Tried to perform an action on item that is deleted.")},addItem:function(a){var b=a.isIn&&a.isIn(this)&&!a.isDeleted()&&a;return this.itemStore.create("",null,b||this.createItem(a)).data},addItems:function(a){return a.map(function(a){return this.addItem(a)},this)},setItems:function(a){this.clear(),this._refreshItems(a)},clear:function(){this.deletedItems=[];var c=this.itemStore=b({sanitize:!1,array:[],getId:function(){return this.fakeUid||(this.fakeUid=0),this.fakeUid+=1,"temp_"+this.fakeUid}});this.tempDataSource=a.createDataSource(function(a){a.setStore(c)})},revertChanges:function(){this.itemStore.array.forEach(function(a){a.revertChanges()}),this.deletedItems.forEach(function(a){this.addItem(a.getData())},this),this.deletedItems.splice(0,this.deletedItems.length)},hasChanges:function(){var a=this.deletedItems.length;return a||(a=this.itemStore.array.some(function(a){return a.hasChanges(!0)})),a},query:function(a,b){var c=this,f=d.defer();return this.emit("willQuery",a),!this.parentItem||this.parentItem.exists()?this.dataSource.query(a).then(function(a){b&&c.clear(),a=angular.extend({},a),a.data=c._refreshItems(a.data),c.serverTotal=a.total,f.resolve(a),c.emit("didQuery",c)},function(a){f.reject(a)}):(c.emit("didQuery",c),e(function(){f.resolve(c)})),f.promise},saveChanges:function(a){var b=(this.idProperty,d.defer()),c=this,e=[],f=[],g=[],h=[],i=[],j=this.deletedItems;return this.itemStore.array.forEach(function(b){b.exists()?b.hasChanges()&&(a&&b.isSaved()||i.push(b.getData(a))):(g.push(b.getData(a)),h.push(b))}),this.emit("willSaveChanges",g.concat(i),j),g.length&&f.push(this.dataSource.create(g).then(function(a){e=e.concat(c._refreshItems(a.data,h))})),i.length&&f.push(this.dataSource.update(i).then(function(a){e=e.concat(c._refreshItems(a.data,i))})),j.length&&f.push(this.dataSource["delete"](j)),d.all(f).then(function(){d.all(c.itemStore.array.map(function(b){return b.saveChildren(a)})).then(function(){b.resolve(e,j),c.emit("didSaveChanges",e,j)},function(a){b.reject(a)})},function(a){b.reject(a)}),b.promise},queryItem:function(a,b){var c=this.idProperty,e=d.defer(),f=this;return a.isIn&&this._verifyItem(a),this.emit("willQueryItem",a,b),b=angular.extend({},b),b[c]=a[c],this.dataSource.get(b).then(function(c){a.isIn?a.setData(c.data):a=f.addItem(c.data),e.resolve(a),f.emit("didQueryItem",a,b)},function(a){e.reject(a)}),e.promise},saveItem:function(a,b){var c=this.getDataSource(b),e=this,f=[];return this._verifyItem(a),this.emit("willSaveItem",a),a.hasChanges()&&f.push(c.save(a.getData()).then(function(b){e._refreshItems([b.data],[a])},function(a){throw a})),d.all(f).then(function(){return d.all(b?[a.saveChildren()]:[]).then(function(){return e.emit("didSaveItem",a),a})},function(a){throw a})},deleteItem:function(a,b){var c=(this.idProperty,d.defer()),e=this;return this._verifyItem(a),this.emit("willDeleteItem",a),this.getDataSource(b)["delete"](a.getData(!1,!0)).then(function(){e.itemStore["delete"]("",a),!a.exists()||b!==!1&&e._canSave()||e.deletedItems.push(a),e.selectedItem===a&&e.selectItem(null),c.resolve(a),e.emit("didDeleteItem",a)},function(a){c.reject(a)}),c.promise},createItem:function(a,b){var c=new f(a,this);return b&&c.select(!0),c},selectItem:function(a){if(!a||a.isIn(this)){var b=this.emit("willSelectItem",a);b.defaultPrevented||(this.selectedItem=a),this.emit("didSelectItem",a)}},get:function(a){return isNaN(a)?this.getAll():this.itemStore.array[a]},getAll:function(){return this.itemStore.array},count:function(){return this.itemStore.array.length},valueOf:function(){return this.itemStore.array.valueOf()},toString:function(){return this.itemStore.array.toString()}}),function(a){return new g(a)}}]}]);