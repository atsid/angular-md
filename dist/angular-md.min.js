angular.module("atsid.namedError",[]).provider("namedError",function(){this.$get=function(){return function(a,b){var c=function(a,c){this.name=a,this.message=c||b};return c.prototype=Error.prototype,c}}}),angular.module("atsid.eventable",[]).provider("eventable",[function(){function a(a){angular.extend(this,a)}a.prototype={_getEventListeners:function(a){var b=this.$eventMessages=this.$eventMessages||{},c=b[a];return c||(c=b[a]=[]),c},hasListeners:function(a){return!!this._getEventListeners(a)},emit:function(a,b){var c=Array.prototype.slice.call(arguments,1),d=this._getEventListeners(a),e={message:a,data:b,preventDefault:function(){e.defaultPrevented=!0},defaultPrevented:!1};return c.unshift(e),d.forEach(function(a){a.fn.apply(null,c)}),e},on:function(a,b){var c=this._getEventListeners(a),d={fn:b,remove:function(){var a=c.indexOf(this);c.splice(a,1)}};return c.push(d),d}},this.$get=function(){return function(b){return new a(b)}}}]),angular.module("atsid.data.store",["atsid.namedError","atsid.eventable"]).provider("store",function(){this.$get=["namedError","eventable",function(a,b){var c={NotImlementedError:a("NotImlementedError","Not implemented")},d=function(a){return b(angular.extend({config:{},read:function(){throw new c.NotImlementedError},create:function(){throw new c.NotImlementedError},update:function(){throw new c.NotImlementedError},patch:function(){throw new c.NotImlementedError},"delete":function(){throw new c.NotImlementedError},createResponse:function(a,b,c){var d=a instanceof Array,e=d?a.length:1;return{data:a,count:e,offset:b||0,total:c||e}},sanitizeData:function(a){for(var b,c={},d=Object.keys(a),e=d.length;e-->0;)b=d[e],/^[$]/.test(d[e])||(c[b]=angular.copy(a[b]));return c},getValueAtPath:function(a,b){var c,d,e=(a||"").split("/");return(e.length>1||e[0])&&(d=b,e.every(function(a){return d=d[a],d?(c=d,!0):void 0})),d}},a))};return d.errors=c,d}]}),angular.module("atsid.data.store").provider("httpStore",[function(){var a={};this.addStore=function(b){if(!angular.isString(b.name))throw new Error("Global http store defaults require a name.");a[b.name]=b},this.$get=["$http","store",function(b,c){function d(b){var c=angular.extend({response:{paths:{count:"count",data:"data",offset:"offset",total:"total"}},methods:{get:null,put:null,patch:null,post:null,"delete":null}},a[b.name]||{});this.config=angular.extend(angular.extend({},c),b)}return d.prototype=c({parseResponse:function(a,b,c){var d=this.getValueAtPath("methods/"+a+"response",b)||b.response,e=d.paths||{},f=this.getValueAtPath(e.data,c)||c;return this.createResponse(f,this.getValueAtPath(e.offset,c),this.getValueAtPath(e.total,c))},buildUrl:function(a,b){var c=this.config.baseUrl||"",d=[];return a=c+"/"+a,angular.forEach(b,function(a,b){d.push(b+"="+a)}),d.length&&(a+="?"+d.join("&")),a},doRequest:function(a,c,d,e,f,g){var h=this.config,i=this;return b({method:a,url:this.buildUrl(c,d),data:f||"",headers:angular.extend(angular.extend({},this.config.headers),e)}).then(function(b){g.resolve(i.parseResponse(a.toLowerCase(),h,b.data))},function(a){g.reject(a)})},read:function(a,b,c,d){this.doRequest("GET",a,b,{},c,d)},create:function(a,b,c,d){this.doRequest("POST",a,b,{},c,d)},update:function(a,b,c,d){this.doRequest("PUT",a,b,{},c,d)},patch:function(a,b,c,d){this.doRequest("PATCH",a,b,{},c,d)},"delete":function(a,b,c,d){this.doRequest("DELETE",a,b,{"Content-Type":angular.isArray(c)?"application/json":null},c,d)}}),function(a){return a=angular.isString(a)?{name:a}:a||{},new d(a)}}]}]),angular.module("atsid.data.store").provider("arrayStore",[function(){this.$get=["store",function(a){function b(a){a=a||{},this.array=angular.isArray(a)?a:a.array||[],this.idProperty=a.idProperty||"id",this.idToItems={},this.sanitize=a.hasOwnProperty("sanitize")?a.sanitize:!0,a.getId&&(this.getId=a.getId),this.uid=0,this.array.length&&this.array.splice(0,this.array.length).forEach(function(a){this._addItem(a)},this)}return b.prototype=a({_addItem:function(a,b){var c=this.idProperty;if(a[c]||(a[c]=this.getId()),this.idToItems[a[c]]){if(!b)return;var d=this.array.indexOf(a);this.array.splice(d,1)}return this.sanitize&&(a=this.sanitizeData(a)),this.idToItems[a[c]]=a,this.array.push(a),this.sanitize?angular.copy(a):a},getId:function(){do this.uid+=1;while(this.idToItems[this.uid]);return this.uid},findItem:function(a){var b=this.idToItems[a];return b&&this.sanitize&&(b=angular.copy(b)),b},hasItem:function(a){return angular.isArray(a)?a.every(function(a){return this.hasItem(a)},this):a[this.idProperty]?!!this.idToItems[a[this.idProperty]]:!!this.idToItems[a]},syncRead:function(a){var b=void 0!==a&&null!==a?this.findItem(a):angular.copy(this.array);return b?this.createResponse(b):void 0},syncCreate:function(a,b,c){this.idProperty;return angular.isArray(c)?this.createResponse(c.map(function(a){return this._addItem(a)},this)):this.createResponse(this._addItem(c))},syncUpdate:function(a,b,c){if(angular.isArray(c)){if(this.hasItem(c))return this.createResponse(c.map(function(a){return this._addItem(a,!0)},this))}else if(this.hasItem(a))return this.createResponse(this._addItem(c,!0))},syncPatch:function(a,b,c){if(angular.isArray(c)){if(this.hasItem(c))return this.createResponse(c.map(function(a){var b=this.findItem(a[this.idProperty]);return angular.extend(b,a),this._addItem(b,!0)},this))}else{var d=this.findItem(a);if(d)return angular.extend(d,c),this.createResponse(this._addItem(d,!0))}},syncDelete:function(a,b,c){if(!c){var d={};return d[this.idProperty]=a,this.syncDelete(null,b,[d])}return this.hasItem(c)?(c.forEach(function(a){a=this.idToItems[a[this.idProperty]];var b=this.array.indexOf(a);this.array.splice(b,1),delete this.idToItems[a[this.idProperty]]},this),this.createResponse(null)):void 0},read:function(a,b,c,d){var e=this.syncRead(a,b);e?d.resolve(e):d.reject(new Error("No item at path "+a))},create:function(a,b,c,d){var e=this.syncCreate(a,b,c);d.resolve(e)},update:function(a,b,c,d){var e=this.syncUpdate(a,b,c);e?d.resolve(e):d.reject(new Error("No item at path "+a))},patch:function(a,b,c,d){var e=this.syncPatch(a,b,c);e?d.resolve(e):d.reject(new Error("No item at path "+a))},"delete":function(a,b,c,d){var e=this.syncDelete(a,b,c);e?d.resolve(e):d.reject(new Error("No item at path "+a))}}),function(a){return new b(a)}}]}]),angular.module("atsid.data",["atsid.eventable","atsid.data.store"]).provider("dataSource",[function(){function a(a){return angular.extend(a,{defaults:{idProperty:"id",fields:null,fetches:null,q:null,orderBy:null,count:100,offset:0,allowAutomaticRoutes:!0},storeConfig:"http",routes:{}}),{setDefaults:function(b){angular.extend(a.defaults,b)},setStore:function(b){a.store=b,a.storeConfig=null},setStoreConfig:function(b){a.storeConfig=b,a.store=null},setStoreUrl:function(b){a.storeConfig={type:"http",baseUrl:b},a.store=null},addRoutes:function(b){angular.extend(a.routes,b)}}}var b={};angular.extend(this,a(b)),this.$get=["$q","httpStore","arrayStore","eventable",function(c,d,e,f){function g(a){return a=angular.isString(a)?{type:"http",name:a}:a,{$:d,http:d,array:e}[a.type||"$"](a)}function h(a,b){{var c=[];a.length-1}return a.forEach(function(a){if(null!==a.name&&c.push(a.name),null!==a.param){var d=b?b[a.param]||null:":"+a.param;d&&c.push(d)}}),c.join("/")}function i(a,b){var c=a.path,d=!c&&b?b.pathComponents.slice(0):[];if(c){c=c.replace(/^\/|\/$/,""),c=c.split("/");for(var e=0;e<c.length;){var f=c[e],g=c[e+1];":"===f.charAt(0)&&(g=f,f=null,e-=1),g=g&&":"===g.charAt(0)?g.substr(1):null,d.push({name:f,param:g}),e+=g?2:1}}else a.name&&d.push({name:a.name,param:"id"+(b.level+1)});return d}function j(a,b){var c=this;if(a=a||{},b){var d=function(){};d.prototype=b,c=new d}var e=c.pathComponents=i(a,b),f=e[e.length-1];return c.config=a,c.path=h(e),c.level=b?b.level+1:1,c.idProperty=a.idProperty||"id",c.parent=b,c.pathName=f&&f.name||"",c.name=a.name||c.pathName,c.pathParam=f&&f.param||"",c.params=a.params||{},c.routes={},c.fields=a.fields,c.fetches=a.fetches,c.q=a.q,c.orderBy=a.orderBy,c.transformers=a.transformers||[],a.count&&(c.count=a.count),a.offset&&(c.offset=a.offset),b||(a.store&&(c.store=a.store),c.nameToRoute={},c.allowAutomaticRoutes=a.allowAutomaticRoutes),a.name&&(c.nameToRoute[a.name]=c),a.routes&&angular.forEach(a.routes,function(a,b){a.path?a.name=b:a.path=b,"/"!==a.path.charAt(0)&&c.path&&(a.path=c.path+"/"+a.path),c.addRoute(a)}),c._self=c,c}function k(a){var b=new j(angular.extend({store:a.store||g(a.storeConfig),routes:a.routes},a.defaults));return b}j.prototype=f({addRoute:function(a){this._adding=!0;var b=a.path?this.getRouteByPath(a.path,!0):this,c=new j(a,b);return b.routes[c.pathName]=c,this._adding=!1,c},child:function(a){if(a=angular.isString(a)?{name:a}:a,!a.name&&!a.path)throw new Error("Cannot create route without a name or path.");var b=this.nameToRoute[a.name]||this.getRouteByPath(a.path||a.name);if(!b){if(!this.allowAutomaticRoutes)throw new Error('Route "'+(a.path||a.name)+'" does not exist.');b=new j(a,this)}return b.getInstance(a)},getRouteByPath:function(a,b){return this.getRouteByPathComponents(i({path:a}),b)},getRouteByPathComponents:function(a,b){var c=this;return b&&(a=a.slice(0,a.length-1)),a.every(function(a){var b=c.routes[a.name];if(!b){if(!c._adding&&!c.allowAutomaticRoutes)return c=void 0,!1;b=c.addRoute({path:a.name})}return c=b,!0}),c},getParent:function(a){var b=this.parent;return b?a&&b.name!==a?b.getParent(a):b:void 0},setParentItem:function(a,b){b||(b=a,a=null);var c=this.getParent(a);c&&c.setItem(b)},getPathParams:function(a){var b={},c=this.getParent(),d=this.pathComponents,e=d.length-2,f=d[e],g=a[this.idProperty]||a[this.pathParam];for(void 0!==g&&null!==g&&(b[this.pathParam]=g);c&&f;)b[f.param]=a[f.param]||c.currentItem&&c.currentItem[c.idProperty],c=c.getParent(),e-=1,f=d[e];return b},setItem:function(a){this.currentItem=a},getInstance:function(a){var b;if(Object.create)b=Object.create(this);else{var c=function(){};c.prototype=this,b=new c}return b.config=angular.extend(angular.copy(this.config),a),angular.extend(b,a||{})},getPath:function(a){var b=this.getPathParams(a);return h(this.pathComponents,b)},getUrl:function(a,b){var c=this.getPath(a);return this.store.buildUrl(c,b||{})},getStoreParams:function(a){var b=angular.extend(angular.extend({fields:this.fields,fetches:this.fetches,q:this.q,count:this.count,offset:this.offset,orderBy:this.orderBy},this.params||{}),a);return this.pathComponents.forEach(function(a){b[a.param]&&delete b[a.param]}),angular.forEach(b,function(a,c){(null===a||void 0===a)&&delete b[c]}),b},isSame:function(a){return a._self===this._self},runTransformers:function(a,b,d){var e=this.transformerMap,f=c.defer();e||(e=this.transformerMap={},(this.transformers||[]).forEach(function(a){var b=e[a.type]=e[a.type]||[];b.push(a)}));var g=e[a];if(g&&b){var h=function(a,b){var e=c.defer(),i=g[a];i?(void 0!==d?i.transform(b,d,e):i.transform(b,e),e.promise.then(function(b){h(a+1,b)},function(a){f.reject(a)})):f.resolve(b)};h(0,b)}else f.resolve(b);return f.promise},doRequest:function(a,b,d){var e=c.defer(),f=e.promise,g=angular.isArray(d),h=!d||g?d:[d],i=this;b=angular.extend(angular.copy(this.params||{}),b||{});var j=this.getPath(b),k=this.getStoreParams(b);return this.runTransformers("request",h).then(function(b){var f=c.defer();b&&!g&&(b=b[0]),f.promise.then(function(a){var b=angular.isArray(a.data),c=!a.data||b?a.data:[a.data];i.runTransformers("response",c,h||[]).then(function(c){b||(c=c[0]),a.data=c,e.resolve(a)},function(a){e.reject(a)})},function(a){e.reject(a)}),i.store[a](j||null,k,d,f)},function(a){e.reject(a)}),f},query:function(a){return this.doRequest("read",a)},get:function(a){return a=angular.isObject(a)?a:{id:a},this.query(a)},create:function(a){var b=a[this.idProperty]||a[this.pathParam],c={};return b&&(c[this.pathParam]=b),this.doRequest("create",c,a)},update:function(a){var b={};return b[this.idProperty]=a[this.idProperty],this.doRequest("update",b,a)},save:function(a){return a.hasOwnProperty(this.idProperty)?this.update(a):this.create(a)},"delete":function(a){var b,c={};return angular.isArray(a)?b=this.doRequest("delete",c,a):(c[this.idProperty]=a[this.idProperty],b=this.doRequest("delete",c)),b},remove:function(a){return this["delete"](a)},batch:function(a,b){var d=[],e=this;b||(b=a,a=null);var f=function(a,b){return b&&d.splice(d.indexOf(b),1),d.push(a),a},g=function(a){return{then:function(b,c){var d=f(a.then(b,c),a);return g(d)}}},h=function(a,b){var c=f(e[a].apply(e,b));return g(c,function(){d.splice(d.indexOf(c),1)})},i=this.getInstance({query:function(){return h("query",arguments)},get:function(){return h("get",arguments)},create:function(){return h("create",arguments)},update:function(){return h("update",arguments)},save:function(){return h("save",arguments)},"delete":function(){return h("delete",arguments)},remove:function(){return h("delete",arguments)}});return a?a.forEach(b,i):b.call(i),c.all(d)}});var l=new k(b),m=function(a){return a?l.child(a):l};return m.createDataSource=function(b){var c={},d=a(c);return b.call(d,d),new k(c)},m}]}]),angular.module("atsid.data.itemCollection",["atsid.eventable","atsid.data"]).provider("itemCollection",[function(){this.$get=["dataSource","arrayStore","eventable","$q","$timeout",function(a,b,c,d,e){function f(a,b){this.$meta={collection:b,originalData:{},unsaved:!1};this.setData(a)}function g(b){this.dataSource=angular.isString(b.dataSource)?a(b.dataSource):b.dataSource,this.idProperty=this.dataSource.idProperty,angular.extend(this,angular.extend({saveWithParent:!1},b));var c=this.parentItem;if(c){var d=this;c.on("didSave",function(){c.exists()&&d.saveChanges(d.saveWithParent?!1:!0)})}this.clear(),b.hasOwnProperty("initialQuery")&&b.initialQuery!==!0||this.query()}return f.prototype=angular.extend(c(),{getData:function(a){var b={},c=a?this.$meta.originalData:this;for(var d in c)c.hasOwnProperty(d)&&"$"!==d.charAt(0)&&(b[d]=c[d]);return b},setData:function(a,b){var c=this.$meta.originalData;for(var d in a)a.hasOwnProperty(d)&&"$meta"!==d&&(b&&this.hasOwnProperty(d)&&c[d]!==this[d]||(this[d]=a[d]),c[d]=a[d])},hasChanges:function(){return!angular.equals(this.getData(),this.$meta.originalData)},query:function(a){return this.$meta.collection.queryItem(this,a).then(function(a){this.setData(a,!0)})},save:function(){var a=this;return this.$meta.collection.saveItem(this).then(function(b,c){a.$meta.unsaved=c,a.emit("didSave",a)})},isSaved:function(){return!this.$meta.unsaved},isDeleted:function(){return this.$meta.deleted},exists:function(){var a=this.$meta.collection.idProperty;return!this.isDeleted()&&this.isSaved()&&this[a]&&0!==String(this[a]).search("temp")},"delete":function(){var a=this;return this.$meta.collection.deleteItem(this).then(function(){a.$meta.unsaved=!1,a.$meta.deleted=!0})},remove:function(){return this["delete"]()},select:function(a){this.$meta.collection.selectItem(this,a)},isIn:function(a){return this.$meta.collection===a},child:function(a){var b=this.$meta.collection,c=angular.extend({initialQuery:!1,saveWithParent:b.saveChildren,saveChildren:b.saveChildren},angular.isString(a)?{dataSource:a}:a);c.parentItem=this;var d=c.dataSource=b.dataSource.child(c.dataSource);return d.setParentItem(this),new g(c)}}),g.prototype=angular.extend(c(),{getDataSource:function(){return this._canSave()?this.dataSource:this.tempDataSource},_refreshItems:function(a,b){return b=b||[],a.map(function(a,c){var d=b[c]&&b[c][this.idProperty]||a[this.idProperty],e=this.itemStore.syncRead(d),f=e&&e.data;return f?f.setData(a):(f=b[c],f&&f.isIn&&f.isIn(this)&&f.setData(a),f=this.addItem(f||a)),f},this)},_canSave:function(){return!this.saveWithParent&&(!this.parentItem||this.parentItem.exists())},_verifyItem:function(a){if(!a.isIn||!a.isIn(this))throw new Error("Tried to perform an action on item that is not within the collection.");if(a.isDeleted())throw new Error("Tried to perform an action on item that is deleted.")},addItem:function(a){var b=a.isIn&&a.isIn(this)&&!a.isDeleted()&&a;return this.itemStore.syncCreate("",null,b||this.createItem(a)).data},addItems:function(a){return a.map(function(a){return this.addItem(a)},this)},clear:function(){this.items=[],this.deletedItems=[];var c=this.itemStore=b({sanitize:!1,array:this.items,getId:function(){return this.fakeUid||(this.fakeUid=0),this.fakeUid+=1,"temp_"+this.fakeUid}});this.tempDataSource=a.createDataSource(function(a){a.setStore(c)})},query:function(a,b){var c=this,f=d.defer();return this.emit("willQuery",a),!this.parentItem||this.parentItem.exists()?this.dataSource.query(a).then(function(a){b&&c.clear(),c._refreshItems(a.data),f.resolve(c),c.emit("didQuery",c)},function(a){f.reject(a)}):(c.emit("didQuery",c),e(function(){f.resolve(c)})),f.promise},saveChanges:function(a){var b=(this.idProperty,d.defer()),c=this,e=[],f=[],g=[],h=[],i=this.deletedItems;return this.items.forEach(function(b){b.hasChanges()&&(a&&b.isSaved()||(b.exists()?h.push(b.getData(a)):g.push(b.getData(a))))}),this.emit("willSaveChanges",h,i),g.length&&f.push(this.dataSource.create(g).then(function(a){e=c._refreshItems(a.data,g)})),h.length&&f.push(this.dataSource.update(h).then(function(a){e=c._refreshItems(a.data,h)})),i.length&&f.push(this.dataSource["delete"](i)),d.all(f).then(function(){b.resolve(e,i),c.emit("didSaveChanges",e,i)},function(a){b.reject(a)}),b.promise},queryItem:function(a,b){var c=this.idProperty,e=d.defer(),f=this;return this._verifyItem(a),this.emit("willQueryItem",a,b),b=angular.extend({},b),b[c]=a[c],this.dataSource.get(b).then(function(c){a.setData(c.data),e.resolve(a),f.emit("didQueryItem",a,b)},function(a){e.reject(a)}),e.promise},saveItem:function(a){var b=this.getDataSource(),c=(this.idProperty,d.defer()),e=this;return this._verifyItem(a),this.emit("willSaveItem",a),b.save(a.getData()).then(function(b){var d=e._refreshItems([b.data],[a]);c.resolve(d[0]),e.emit("didSaveItem",d[0])},function(a){c.reject(a)}),c.promise},deleteItem:function(a){var b=this.idProperty,c=d.defer(),e=this;return this._verifyItem(a),this.emit("willDeleteItem",a),this.getDataSource()["delete"](a.getData()).then(function(){e.itemStore.syncDelete(a[b]),a.exists()&&!e._canSave()&&e.deletedItems.push(a),e.selectedItem===a&&e.selectItem(null),c.resolve(a),e.emit("didDeleteItem",a)},function(a){c.reject(a)}),c.promise},createItem:function(a,b){var c=new f(a,this);return b&&c.select(!0),c},selectItem:function(a){if(!a||a.isIn(this)){var b=this.emit("willSelectItem",a);b.defaultPrevented||(this.selectedItem=a),this.emit("didSelectItem",a)}},get:function(a){return isNaN(a)?this.getAll():this.items[a]},getAll:function(){return this.items},count:function(){return this.items.length},valueOf:function(){return this.items.valueOf()},toString:function(){return this.items.toString()}}),function(a){return new g(a)}}]}]);