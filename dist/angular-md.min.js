"use strict";angular.module("atsid.data.store",[]).provider("httpStore",["$httpProvider",function(a){var b=a.defaults.headers["delete"]=a.defaults.headers["delete"]||{};b["Content-Type"]="application/json;charset=utf-8",a.responseInterceptors.push(["$q",function(){return function(a){return a.then(function(a){var b=a.config.method.toLowerCase();return("post"===b||"put"===b)&&a.data.data&&angular.isArray(a.data.data)&&(a.data=a.data.data),a})}}]);var c={};this.addStore=function(a){if(!angular.isString(a.name))throw new Error("global http store defaults require a name.");c[a.name]=a},this.$get=["$http",function(a){function b(a){var b=angular.extend({response:{paths:{count:"count",data:"data",offset:"offset",total:"total"}},methods:{get:null,put:null,patch:null,post:null,"delete":null}},c[a.name]||{});this.config=angular.extend(angular.extend({},b),a)}function d(a,b){var c,d,e=(a||"").split("/");return(e.length>1||e[0])&&(d=b,e.every(function(a){return d=d[a],d?(c=d,!0):void 0})),d}function e(a,b,c){var e=d("methods/"+a+"response",b)||b.response,f=e.paths||{},g=d(f.data,c)||c,h=angular.isArray(g)?g.length:1;return{data:g,count:h,offset:d(f.offset,c)||0,total:d(f.total,c)||h}}return b.prototype={buildUrl:function(a,b){var c=this.config.baseUrl||"",d=[];return a=c+"/"+a,angular.forEach(b,function(a,b){d.push(b+"="+a)}),d.length&&(a+="?"+d.join("&")),a},doRequest:function(b,c,d,f,g,h){var i=this.config;return a({method:b,url:this.buildUrl(c,d),data:g||"",headers:angular.extend(angular.extend({},this.config.headers),f)}).then(function(a){h.resolve(e(b.toLowerCase(),i,a.data))},function(a){h.reject(a)})},read:function(a,b,c,d){this.doRequest("GET",a,b,{},null,d)},create:function(a,b,c,d){this.doRequest("POST",a,b,{},c||null,d)},update:function(a,b,c,d){this.doRequest("PUT",a,b,{},c||null,d)},patch:function(a,b,c,d){this.doRequest("PATCH",a,b,{},c||null,d)},"delete":function(a,b,c,d){this.doRequest("DELETE",a,b,{"Content-Type":null},c||null,d)}},function(a){return a=angular.isString(a)?{name:a}:a,new b(a)}}]}]),angular.module("atsid.data.store").provider("arrayStore",[function(){this.$get=[function(){function a(a){a=a||{},this.array=angular.isArray(a)?a:a.array||[],this.idProperty=a.idProperty||"id",this.idToItems={},a.getId&&(this.getId=a.getId),this.uid=0}return a.prototype={getId:function(){return this.uid+=1,this.uid},findItem:function(a){return this.idToItems[a]},syncRead:function(a){return this.findItem(a)},syncCreate:function(a,b,c){var d=this.idProperty;return angular.isArray(c)?c.map(function(a){return this.syncCreate(a)},this):(c[d]||(c[d]=this.getId()),this.idToItems[d]?void 0:(this.array.push(c),this.idToItems[c[d]]=c,c))},syncUpdate:function(a,b,c){if(angular.isArray(c))return c.map(function(a){return this.syncUpdate(a)},this);var d=this.findItem(a);if(d){var e=this.array.indexOf(d);return this.array.splice(e,1,c),delete this.idToItems[a],this.idToItems[d[this.idProperty]]=d,c}},syncPatch:function(a,b,c){if(angular.isArray(c))return c.map(function(a){return this.syncPatch(a)},this);var d=this.findItem(a);return d?(angular.extend(d,c),d):void 0},syncDelete:function(a,b,c){if(angular.isArray(c))return c.map(function(a){return this.syncDelete(a)},this);if(c=this.findItem(a)){var d=this.array.indexOf(c);return this.array.splice(d,1),delete this.idToItems[c[this.idProperty]],c}},read:function(a,b,c){var d=this.syncRead(a,b);d?c.resolve(angular.copy(d)):c.resolve(new Error("No item at path "+a))},create:function(a,b,c,d){var e=this.syncCreate(a,b,c);d.resolve(e)},update:function(a,b,c,d){var e=this.syncUpdate(a,b,c);e?d.resolve(angular.copy(e)):d.resolve(new Error("No item at path "+a))},patch:function(a,b,c,d){var e=this.syncPath(a,b,c);e?d.resolve(angular.copy(e)):d.resolve(new Error("No item at path "+a))},"delete":function(a,b,c,d){var e=this.syncDelete(a,b,c);e?d.resolve({}):d.resolve(new Error("No item at path "+a))}},function(b){return b=angular.isString(b)?{name:b}:b,new a(b)}}]}]),angular.module("atsid.data",["atsid.data.store"]).provider("dataSource",[function(){function a(a){return angular.extend(a,{defaults:{idProperty:"id",fields:null,fetches:null,q:null,orderBy:null,count:100,offset:0,allowAutomaticRoutes:!0},storeConfig:"http",routes:{}}),{setDefaults:function(b){angular.extend(a.defaults,b)},setStore:function(b){a.store=b,a.storeConfig=null},setStoreConfig:function(b){a.storeConfig=b,a.store=null},setStoreUrl:function(b){a.storeConfig={type:"http",baseUrl:b},a.store=null},addRoutes:function(b){angular.extend(a.routes,b)}}}var b={};angular.extend(this,a(b)),this.$get=["$q","httpStore","arrayStore",function(c,d,e){function f(a){return a=angular.isString(a)?{type:"http",name:a}:a,{$:d,http:d,array:e}[a.type||"$"](a)}function g(a,b){{var c=[];a.length-1}return a.forEach(function(a){if(null!==a.name&&c.push(a.name),null!==a.param){var d=b?b[a.param]||null:":"+a.param;d&&c.push(d)}}),c.join("/")}function h(a,b){var c=a.path,d=!c&&b?b.pathComponents.slice(0):[];if(c){c=c.replace(/^\/|\/$/,""),c=c.split("/");for(var e=0;e<c.length;){var f=c[e],g=c[e+1];":"===f.charAt(0)&&(g=f,f=null,e-=1),g=g&&":"===g.charAt(0)?g.substr(1):null,d.push({name:f,param:g}),e+=g?2:1}}else a.name&&d.push({name:a.name,param:"id"+(b.level+1)});return d}function i(a,b){var c=this;if(a=a||{},b){var d=function(){};d.prototype=b,c=new d}var e=c.pathComponents=h(a,b),f=e[e.length-1];return c.config=a,c.path=g(e),c.level=b?b.level+1:1,c.idProperty=a.idProperty||"id",c.parent=b,c.pathName=f&&f.name||"",c.name=a.name||c.pathName,c.pathParam=f&&f.param||"",c.params=a.params||{},c.routes={},c.fields=a.fields,c.fetches=a.fetches,c.q=a.q,c.orderBy=a.orderBy,c.transformers=a.transformers||[],a.count&&(c.count=a.count),a.offset&&(c.offset=a.offset),b||(a.store&&(c.store=a.store),c.nameToRoute={},c.allowAutomaticRoutes=a.allowAutomaticRoutes),a.name&&(c.nameToRoute[a.name]=c),a.routes&&angular.forEach(a.routes,function(a,b){a.path?a.name=b:a.path=b,"/"!==a.path.charAt(0)&&c.path&&(a.path=c.path+"/"+a.path),c.addRoute(a)}),c._self=c,c}function j(a){var b=new i(angular.extend({store:a.store||f(a.storeConfig),routes:a.routes},a.defaults));return b}i.prototype={addRoute:function(a){this._adding=!0;var b=a.path?this.getRouteByPath(a.path,!0):this,c=new i(a,b);return b.routes[c.pathName]=c,this._adding=!1,c},child:function(a){if(a=angular.isString(a)?{name:a}:a,!a.name&&!a.path)throw new Error("Cannot create route without a name or path.");var b=this.nameToRoute[a.name]||this.getRouteByPath(a.path||a.name);if(!b){if(!this.allowAutomaticRoutes)throw new Error('Route "'+(a.path||a.name)+'" does not exist.');b=new i(a,this)}return b.getInstance(a)},getRouteByPath:function(a,b){return this.getRouteByPathComponents(h({path:a}),b)},getRouteByPathComponents:function(a,b){var c=this;return b&&(a=a.slice(0,a.length-1)),a.every(function(a){var b=c.routes[a.name];if(!b){if(!c._adding&&!c.allowAutomaticRoutes)return c=void 0,!1;b=c.addRoute({path:a.name})}return b=c,!0}),c},getParent:function(a){var b=this.parent;return b?a&&b.name!==a?b.getParent(a):b:void 0},setParentItem:function(a,b){b||(b=a,a=null);var c=this.getParent(a);c&&c.setItem(b)},getPathParams:function(a){var b={},c=this.getParent(),d=this.pathComponents,e=d.length-2,f=d[e],g=a[this.idProperty]||a[this.pathParam];for(g&&(b[this.pathParam]=g);c&&f;)b[f.param]=a[f.param]||c.currentItem&&c.currentItem[c.idProperty],c=c.getParent(),e-=1,f=d[e];return b},setItem:function(a){this.currentItem=a},getInstance:function(a){var b;if(Object.create)b=Object.create(this);else{var c=function(){};c.prototype=this,b=new c}return b.config=angular.extend(angular.copy(this.config),a),angular.extend(b,a||{})},getPath:function(a){var b=this.getPathParams(a);return g(this.pathComponents,b)},getUrl:function(a,b){var c=this.getPath(a);return this.store.buildUrl(c,b||{})},getStoreParams:function(a){var b=angular.extend(angular.extend({fields:this.fields,fetches:this.fetches,q:this.q,count:this.count,offset:this.offset,orderBy:this.orderBy},this.params||{}),a);return this.pathComponents.forEach(function(a){b[a.param]&&delete b[a.param]}),angular.forEach(b,function(a,c){(null===a||void 0===a)&&delete b[c]}),b},isSame:function(a){return a._self===this._self},runTransformers:function(a,b,d){var e=this.transformerMap,f=c.defer();e||(e=this.transformerMap={},(this.transformers||[]).forEach(function(a){var b=e[a.type]=e[a.type]||[];b.push(a)}));var g=e[a];if(g&&b){var h=function(a,b){var e=c.defer(),i=g[a];i?(void 0!==d?i.transform(b,d,e):i.transform(b,e),e.promise.then(function(b){h(a+1,b)},function(a){f.reject(a)})):f.resolve(b)};h(0,b)}else f.resolve(b);return f.promise},doRequest:function(a,b,d){var e=c.defer(),f=e.promise,g=angular.isArray(d),h=!d||g?d:[d],i=this;return b=angular.extend(angular.copy(this.params||{}),b||{}),this.runTransformers("request",h).then(function(f){var j=c.defer();f&&!g&&(f=f[0]),j.promise.then(function(a){var b=angular.isArray(a.data),c=!a.data||b?a.data:[a.data];i.runTransformers("response",c,h||[]).then(function(c){b||(c=c[0]),a.data=c,e.resolve(a)},function(a){e.reject(a)})}),i.store[a](i.getPath(b),i.getStoreParams(b),d,j)},function(a){e.reject(a)}),f},query:function(a){return this.doRequest("read",a)},get:function(a){return a=angular.isObject(a)?a:{id:a},this.query(a)},create:function(a){var b=a[this.idProperty]||a[this.pathParam],c={};return b&&(c[this.pathParam]=b),this.doRequest("create",c,a)},update:function(a){var b={};return b[this.idProperty]=a[this.idProperty],this.doRequest("update",b,a)},save:function(a){return a.hasOwnProperty(this.idProperty)?this.update(a):this.create(a)},"delete":function(a){var b,c={};return angular.isArray(a)?b=this.doRequest("delete",c,a):(c[this.idProperty]=a[this.idProperty],b=this.doRequest("delete",c)),b},remove:function(a){return this["delete"](a)},batch:function(a,b){var d=[],e=this;b||(b=a,a=null);var f=function(a){return{then:function(b,c){var e=a.then(b,c);return d.push(e),f(e)}}},g=function(a,b){var c=e.query.apply(e,b);return d.push(c),f(c)},h=this.getInstance({query:function(){return g("query",arguments)},get:function(){return g("get",arguments)},create:function(){return g("create",arguments)},update:function(){return g("update",arguments)},save:function(){return g("save",arguments)},"delete":function(){return g("update",arguments)},remove:function(){return g("update",arguments)}});return a?a.forEach(function(a,c){b.call(h,a,c)}):b.call(h),c.all(d)}};var k=new j(b),l=function(a){return a?k.child(a):k};return l.createDataSource=function(b){var c={},d=a(c);return b.call(d,d),new j(c)},l}]}]),angular.module("atsid.data.item",["atsid.data"]).provider("itemCollection",[function(){this.$get=["dataSource","arrayStore","$q","$timeout",function(a,b,c,d){function e(){}function f(a,b){this.$meta={collection:b,originalData:{},unsaved:!1};this.setData(a)}function g(b){this.dataSource=angular.isString(b.dataSource)?a(b.dataSource):b.dataSource,this.idProperty=this.dataSource.idProperty,angular.extend(this,angular.extend({saveWithParent:!1},b));var c=this.parentItem;if(c){var d=this;c.on("didSave",function(){c.exists()&&d.saveChanges(d.saveWithParent?!1:!0)})}this.clear(),b.hasOwnProperty("initialQuery")&&b.initialQuery!==!0||this.query()}return e.prototype={getEventHandlers:function(a){var b=this.$eventHandlers=this.$eventHandlers||{},c=b[a];return c||(c=b[a]=[]),c},emit:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.getEventHandlers(a),d={message:a,collection:this,preventDefault:function(){d.defaultPrevented=!0},defaultPrevented:!1};return b.unshift(d),c&&c.forEach(function(a){a.fn.apply(null,b)}),d},on:function(a,b){var c=this.getEventHandlers(a),d={fn:b,remove:function(){var a=c.indexOf(this);-1!=a&&c.splice(a,1)}};return c.push(d),d}},f.prototype=angular.extend(new e,{getData:function(a){var b={},c=a?this.$meta.originalData:this;for(var d in c)c.hasOwnProperty(d)&&"$"!==d.charAt(0)&&(b[d]=c[d]);return b},setData:function(a,b){var c=this.$meta.originalData;for(var d in a)a.hasOwnProperty(d)&&"$meta"!==d&&(b&&this.hasOwnProperty(d)&&c[d]!==this[d]||(this[d]=a[d]),c[d]=a[d])},hasChanges:function(){return!angular.equals(this.getData(),this.$meta.originalData)},query:function(a){return this.$meta.collection.queryItem(this,a).then(function(a){this.setData(a,!0)})},save:function(){var a=this;return this.$meta.collection.saveItem(this).then(function(b,c){a.$meta.unsaved=c,a.emit("didSave",a)})},isSaved:function(){return!this.$meta.unsaved},isDeleted:function(){return this.$meta.deleted},exists:function(){var a=this.$meta.collection.idProperty;return!this.isDeleted()&&this.isSaved()&&this[a]&&0!==String(this[a]).search("temp")},"delete":function(){var a=this;return this.$meta.collection.deleteItem(this).then(function(){a.$meta.unsaved=!1,a.$meta.deleted=!0})},remove:function(){return this["delete"]()},select:function(a){this.$meta.collection.selectItem(this,a)},isIn:function(a){return this.$meta.collection===a},child:function(a){var b=this.$meta.collection,c=angular.extend({initialQuery:!1,saveWithParent:b.saveChildren,saveChildren:b.saveChildren},angular.isString(a)?{dataSource:a}:a);c.parentItem=this;var d=c.dataSource=b.dataSource.child(c.dataSource);return d.setParentItem(this),new g(c)}}),g.prototype=angular.extend(new e,{getDataSource:function(){return this._canSave()?this.dataSource:this.tempDataSource},_refreshItems:function(a,b){return b=b||[],a.map(function(a,c){var d=b[c]&&b[c][this.idProperty]||a[this.idProperty],e=this.itemStore.syncRead(d);return e?e.setData(a):(e=b[c],e&&e.isIn&&e.isIn(this)&&e.setData(a),e=this.addItem(e||a)),e},this)},_canSave:function(){return!this.saveWithParent&&(!this.parentItem||this.parentItem.exists())},_verifyItem:function(a){if(!a.isIn||!a.isIn(this))throw new Error("Tried to perform an action on item that is not within the collection.");if(a.isDeleted())throw new Error("Tried to perform an action on item that is deleted.")},addItem:function(a){var b=a.isIn&&a.isIn(this)&&!a.isDeleted()&&a;return this.itemStore.syncCreate("",null,b||this.createItem(a))},addItems:function(a){return a.map(function(a){return this.addItem(a)},this)},clear:function(){this.items=[],this.deletedItems=[];var c=this.itemStore=b({array:this.items,getId:function(){return this.fakeUid||(this.fakeUid=0),this.fakeUid+=1,"temp_"+this.fakeUid}});this.tempDataSource=a.createDataSource(function(a){a.setStore(c)})},query:function(a,b){var e=this,f=c.defer();return this.emit("willQuery",a),!this.parentItem||this.parentItem.exists()?this.dataSource.query(a).then(function(a){b&&e.clear(),e._refreshItems(a.data),f.resolve(e),e.emit("didQuery",e)},function(a){f.reject(a)}):(e.emit("didQuery",e),d(function(){f.resolve(e)})),f.promise},saveChanges:function(a){var b=(this.idProperty,c.defer()),d=this,e=[],f=[],g=[],h=[],i=this.deletedItems;return this.items.forEach(function(b){b.hasChanges()&&(a&&b.isSaved()||(b.exists()?h.push(b.getData(a)):g.push(b.getData(a))))}),this.emit("willSaveChanges",h,i),g.length&&f.push(this.dataSource.create(g).then(function(a){e=d._refreshItems(a.data,g)})),h.length&&f.push(this.dataSource.update(h).then(function(a){e=d._refreshItems(a.data,h)})),i.length&&f.push(this.dataSource["delete"](i)),c.all(f).then(function(){b.resolve(e,i),d.emit("didSaveChanges",e,i)},function(a){b.reject(a)}),b.promise},queryItem:function(a,b){var d=this.idProperty,e=c.defer(),f=this;return this._verifyItem(a),this.emit("willQueryItem",a,b),b=angular.extend({},b),b[d]=a[d],this.dataSource.get(b).then(function(c){a.setData(c.data),e.resolve(a),f.emit("didQueryItem",a,b)},function(a){e.reject(a)}),e.promise},saveItem:function(a){var b=this.getDataSource(),d=(this.idProperty,c.defer()),e=this;return this._verifyItem(a),this.emit("willSaveItem",a),b.save(a.getData()).then(function(b){var c=e._refreshItems([b.data],[a]);d.resolve(c[0]),e.emit("didSaveItem",c[0])},function(a){d.reject(a)}),d.promise},deleteItem:function(a){var b=this.idProperty,d=c.defer(),e=this;return this._verifyItem(a),this.emit("willDeleteItem",a),this.getDataSource()["delete"](a.getData()).then(function(){e.itemStore.syncDelete(a[b]),a.exists()&&!e._canSave()&&e.deletedItems.push(a),e.selectedItem===a&&e.selectItem(null),d.resolve(a),e.emit("didDeleteItem",a)},function(a){d.reject(a)}),d.promise},createItem:function(a,b){var c=new f(a,this);return b&&c.select(!0),c},selectItem:function(a){if(!a||a.isIn(this)){var b=this.emit("willSelectItem",a);b.defaultPrevented||(this.selectedItem=a),this.emit("didSelectItem",a)}},get:function(a){return isNaN(a)?this.getAll():this.items[a]},getAll:function(){return this.items},count:function(){return this.items.length},valueOf:function(){return this.items.valueOf()},toString:function(){return this.items.toString()}}),function(a){return new g(a)}}]}]);