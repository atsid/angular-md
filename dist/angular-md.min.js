"use strict";angular.module("atsid.data",["atsid.data.store"]).provider("dataSource",[function(){function a(a){return angular.extend(a,{defaults:{idProperty:"id",fields:null,fetches:null,q:null,count:100,offset:0},storeConfig:"http",routes:[]}),{setDefaults:function(b){angular.extend(a.defaults,b)},setStore:function(b){a.store=b,a.storeConfig=null},setStoreConfig:function(b){a.storeConfig=b,a.store=null},setStoreUrl:function(b){a.storeConfig={type:"http",baseUrl:b},a.store=null},addRoutes:function(b){b=angular.isArray(b)?b:[b],a.routes.push.apply(a.routes,b)}}}var b={};angular.extend(this,a(b)),this.$get=["$q","httpStore",function(c,d){function e(a){return a=angular.isString(a)?{type:"http",name:a}:a,{$:d,http:d}[a.type||"$"](a)}function f(a,b){{var c=[];a.length-1}return a.forEach(function(a){var d=b?b[a.param]||null:":"+a.param;c.push(a.name),null!==d&&c.push(d)}),c.join("/")}function g(a,b){var c=a.path,d=!c&&b?b.pathComponents.slice(0):[];if(c){c=c.replace(/^\/|\/$/,""),c=c.split("/");for(var e=0;e<c.length;){var f=c[e],g=c[e+1];g=":"===g.charAt(0)?g.substr(1):null,d.push({name:f,param:g}),e+=g?2:1}}else a.name&&d.push({name:a.name,param:"id"+(b.level+1)});return d}function h(a,b){var c=this;if(a=a||{},b){var d=function(){};d.prototype=b,c=new d}var e=c.pathComponents=g(a,b),h=e[e.length-1];return c.path=f(e),c.level=b?b.level+1:1,c.idProperty=a.idProperty||"id",c.parent=b,c.name=a.name||h&&h.name||"",c.pathParams={},c.params=a.params||{},c.routes={},c.fields=a.fields,c.fetches=a.fetches,c.q=a.q,a.count&&(c.count=a.count),a.offset&&(c.offset=a.offset),a.store&&!b&&(c.store=a.store),a.routes&&a.routes.forEach(function(a){c.addRoute(a)}),c}function i(a){var b=new h(angular.extend({store:a.store||e(a.storeConfig),routes:a.routes},a.defaults));return b}h.prototype={addRoute:function(a){var b=a.path?this.getRouteByPath(a.path,!0):this,c=new h(a,b);b.routes[c.name]=c},child:function(a){if(a=angular.isString(a)?{name:a}:a,!a.name&&!a.path)throw new Error("Cannot create route without a name or path.");var b=this.routes[a.name];return b?b.getInstance(a):new h(a,this)},getRouteByPath:function(a,b){return this.getRouteByPathComponents(g({path:a}),b)},getRouteByPathComponents:function(a,b){var c=this;return b&&(a=a.slice(0,a.length-1)),a.forEach(function(a){var b=c.routes[a.name];if(!b)throw new Error("Missing route "+a.name+" when creating "+c.path+".");c=b}),c},getParent:function(a){var b=this.parent;return b?a&&b.name!==a?b.getParent(a):b:void 0},setParentItem:function(a,b){b||(b=a,a=null);var c,d=this.pathComponents,e=this.getParent(a),f=e&&e.idProperty||"id";d.length>1&&(a?d.some(function(b){return b.name===a?(c=b,!0):void 0}):c=d[d.length-2],c&&(this.pathParams[c.param]=b[f]))},getInstance:function(a){var b;if(Object.create)b=Object.create(this);else{var c=function(){};c.prototype=this,b=new c}return angular.extend(b,a||{})},getPathParams:function(a){var b=angular.extend({},this.pathParams),c=this.pathComponents[this.pathComponents.length-1].param,d=a&&(a[c]||a.id)||null;return b[c]=d,b},getPath:function(a){var b=this.getPathParams(a);return f(this.pathComponents,b)},getStoreParams:function(a){var b=angular.extend(angular.extend({fields:this.fields,fetches:this.fetches,q:this.q,count:this.count,offset:this.offset},this.params||{}),a);return this.pathComponents.forEach(function(a){b[a.name]&&delete b[a.name]}),angular.forEach(b,function(a,c){(null===a||void 0===a)&&delete b[c]}),b},doRequest:function(a,b,d){var e=c.defer();return b=b||{},"read"===a?this.store[a](this.getPath(b),this.getStoreParams(b),e):this.store[a](this.getPath(b),this.getStoreParams(b),d,e),e.promise},query:function(a){return this.doRequest("read",a)},get:function(a){return a=angular.isObject(a)?a:{id:a},this.query(a)},create:function(a){return this.doRequest("create",null,a)},update:function(a){var b={};return b[this.idProperty]=a[this.idProperty],this.doRequest("update",b,a)},save:function(a){return a.hasOwnProperty(this.idProperty)?this.update(a):this.create(a)},"delete":function(a){var b={};return b[this.idProperty]=a[this.idProperty],this.doRequest("delete",b)},remove:function(a){return this["delete"](a)}};var j=new i(b),k=function(a){return a?j.child(a):j};return k.createDataSource=function(b){var c={};return b(a(c)),new i(c)},k}]}]),angular.module("atsid.data.store",[]).provider("httpStore",["$httpProvider",function(a){var b=a.defaults.headers["delete"]=a.defaults.headers["delete"]||{};b["Content-Type"]="application/json;charset=utf-8",a.responseInterceptors.push(["$q",function(){return function(a){return a.then(function(a){var b=a.config.method.toLowerCase();return("post"===b||"put"===b)&&a.data.data&&angular.isArray(a.data.data)&&(a.data=a.data.data),a})}}]);var c={};this.addStore=function(a){if(!angular.isString(a.name))throw new Error("global http store defaults require a name.");c[a.name]=a},this.$get=["$http",function(a){function b(a){var b=angular.extend({response:{paths:{count:"count",data:"data",offset:"offset",total:"total"}},methods:{get:null,put:null,patch:null,post:null,"delete":null}},c[a.name]||{});this.config=angular.extend(angular.extend({},b),a)}function d(a,b){var c,d,e=(a||"").split("/");return(e.length>1||e[0])&&(d=b,e.every(function(a){return d=d[a],d?(c=d,!0):void 0})),d}function e(a,b,c){var e=d("methods/"+a+"response",b)||b.response,f=e.paths||{},g=d(f.data,c)||c,h=angular.isArray(g)?g.length:1;return{data:g,count:h,offset:d(f.offset,c)||0,total:d(f.total,c)||h}}return b.prototype={buildUrl:function(a,b){var c=this.config.baseUrl||"",d=[];return a=c+"/"+a,angular.forEach(b,function(a,b){d.push(b+"="+a)}),d.length&&(a+="?"+d.join("&")),a},doRequest:function(b,c,d,f,g){var h=this.config;return a(angular.extend({method:b,url:this.buildUrl(c,d),data:f||null,headers:this.config.headers}),d).then(function(a){g.resolve(e(b.toLowerCase(),h,a.data))},function(a){g.reject(a)})},read:function(a,b,c){this.doRequest("GET",a,b,null,c)},create:function(a,b,c,d){this.doRequest("POST",a,b,c,d)},update:function(a,b,c,d){this.doRequest("PUT",a,b,c,d)},patch:function(a,b,c,d){this.doRequest("PATCH",a,b,c,d)},"delete":function(a,b,c,d){this.doRequest("DELETE",a,b,null,d)}},function(a){return a=angular.isString(a)?{name:a}:a,new b(a)}}]}]);